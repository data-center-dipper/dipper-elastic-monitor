<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dipper.monitor.mapper.KillTimeoutRecordMapper">

    <!-- 插入记录 -->
    <insert id="insert">
        INSERT INTO t_slow_query_kill (
        query_id,
        index_name,
        query_type,
        kill_time,
        execution_time,
        status,
        reason,
        node_id,
        task_id,
        query_content
        ) VALUES (
        #{queryId},
        #{indexName},
        #{queryType},
        #{killTime},
        #{executionTime},
        #{status},
        #{reason},
        #{nodeId},
        #{taskId},
        #{queryContent}
        )
    </insert>

    <!-- 分页查询 -->
    <!-- 分页查询 -->
    <select id="queryPage" resultType="com.dipper.monitor.entity.elastic.slowsearch.KillTimeoutRecord">
        SELECT *
        FROM t_slow_query_kill
        <where>
            <!-- 搜索关键词：来自 killPageReq.searchText -->
            <if test="killPageReq.searchText != null and killPageReq.searchText != ''">
                AND (
                index_name LIKE CONCAT('%', #{killPageReq.searchText}, '%')
                OR query_content LIKE CONCAT('%', #{killPageReq.searchText}, '%')
                OR node_id LIKE CONCAT('%', #{killPageReq.searchText}, '%')
                OR task_id LIKE CONCAT('%', #{killPageReq.searchText}, '%')
                OR reason LIKE CONCAT('%', #{killPageReq.searchText}, '%')
                )
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 计数查询 -->
    <select id="count" resultType="long">
        SELECT COUNT(*)
        FROM t_slow_query_kill
        <where>
            <if test="searchText != null and searchText != ''">
                AND (
                index_name LIKE CONCAT('%', #{searchText}, '%')
                OR query_content LIKE CONCAT('%', #{searchText}, '%')
                OR node_id LIKE CONCAT('%', #{searchText}, '%')
                OR task_id LIKE CONCAT('%', #{searchText}, '%')
                OR reason LIKE CONCAT('%', #{searchText}, '%')
                )
            </if>
        </where>
    </select>

    <!-- 根据 ID 查询单条记录 -->
    <select id="getById" parameterType="int"
            resultType="com.dipper.monitor.entity.elastic.slowsearch.KillTimeoutRecord">
        SELECT * FROM t_slow_query_kill WHERE id = #{id}
    </select>

</mapper>