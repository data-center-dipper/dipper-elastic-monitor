<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.dipper.monitor.mapper.SlowQueryMapper">

    <!-- 插入一条慢查询记录 -->
    <insert id="insertSlowQuery">
        INSERT INTO slow_query (
        cluster_code,
        index_name,
        query_type,
        start_time,
        execution_time,
        status,
        node_id,
        node_name,
        task_id,
        query_content,
        stack_trace,
        collect_time
        ) VALUES (
        #{clusterCode},
        #{indexName},
        #{queryType},
        #{startTime},
        #{executionTime},
        #{status},
        #{nodeId},
        #{nodeName},
        #{taskId},
        #{queryContent},
        #{stackTrace},
        #{collectTime}
        )
    </insert>

    <!-- 批量插入 -->
    <insert id="saveSlowQueries">
        INSERT INTO slow_query (
        cluster_code,
        index_name,
        query_type,
        start_time,
        execution_time,
        status,
        node_id,
        node_name,
        task_id,
        query_content,
        stack_trace,
        collect_time
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.clusterCode},
            #{item.indexName},
            #{item.queryType},
            #{item.startTime},
            #{item.executionTime},
            #{item.status},
            #{item.nodeId},
            #{item.nodeName},
            #{item.taskId},
            #{item.queryContent},
            #{item.stackTrace},
            #{item.collectTime}
            )
        </foreach>
    </insert>

    <!-- 根据 ID 删除记录 -->
    <delete id="deleteById">
        DELETE FROM slow_query WHERE id = #{id}
    </delete>

    <!-- 更新记录 -->
    <update id="updateSlowQuery">
        UPDATE slow_query
        SET
        cluster_code = #{clusterCode},
        index_name = #{indexName},
        query_type = #{queryType},
        start_time = #{startTime},
        execution_time = #{executionTime},
        status = #{status},
        node_id = #{nodeId},
        node_name = #{nodeName},
        task_id = #{taskId},
        query_content = #{queryContent},
        stack_trace = #{stackTrace},
        collect_time = #{collectTime}
        WHERE id = #{id}
    </update>

    <!-- 根据 ID 查询记录 -->
    <select id="selectById" resultType="com.example.entity.SlowQueryEntity">
        SELECT * FROM slow_query WHERE id = #{id}
    </select>

    <!-- 分页查询 -->
    <select id="selectByPage" resultType="com.example.entity.SlowQueryEntity">
        SELECT *
        FROM slow_query
        <where>
            <if test="clusterCode != null and clusterCode != ''">
                AND cluster_code LIKE CONCAT('%', #{clusterCode}, '%')
            </if>
            <if test="queryType != null and queryType != ''">
                AND query_type = #{queryType}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="startTime != null and startTime != ''">
                AND start_time >= #{startTime}
            </if>
        </where>
        ORDER BY collect_time DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- 获取总记录数（用于分页） -->
    <select id="countByPage" resultType="int">
        SELECT COUNT(*)
        FROM slow_query
        <where>
            <if test="clusterCode != null and clusterCode != ''">
                AND cluster_code LIKE CONCAT('%', #{clusterCode}, '%')
            </if>
            <if test="queryType != null and queryType != ''">
                AND query_type = #{queryType}
            </if>
            <if test="status != null and status != ''">
                AND status = #{status}
            </if>
            <if test="startTime != null and startTime != ''">
                AND start_time >= #{startTime}
            </if>
        </where>
    </select>

    <!-- 批量查询 by IDs -->
    <select id="selectByIds" resultType="com.example.entity.SlowQueryEntity">
        SELECT *
        FROM slow_query
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

</mapper>