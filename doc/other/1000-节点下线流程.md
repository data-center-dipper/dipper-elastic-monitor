在 Elasticsearch 中，如果你想要**安全地下线一个节点（Node）**，不能简单地直接关闭该节点的进程或服务器，否则可能会导致数据丢失、分片未分配、集群状态异常等问题。

---

## ✅ 一、下线节点前的准备

### 1. 确保集群健康状态良好
执行以下命令检查集群状态：

```bash
GET _cluster/health?pretty
```

- `status` 应为 `"green"`。
- 如果是 `"yellow"`，说明副本分片有缺失，虽然不影响下线操作，但建议先解决。
- 如果是 `"red"`，说明有主分片丢失，**不建议下线节点**，应先修复问题。

---

### 2. 查看当前节点信息和角色

```bash
GET _cat/nodes?v
```

你会看到类似如下内容：

```
ip         heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name
10.0.0.10           45          70   2    0.10    0.05     0.01 mdi       *      node-1
10.0.0.11           30          65   1    0.05    0.03     0.01 mdi       -      node-2
10.0.0.12           25          60   1    0.04    0.02     0.01 mdi       -      node-3
```

注意：
- `node.role`：表示节点的角色，如 `mdi`（master, data, ingest）、`d`（data-only）等。
- `master` 列中的 `*` 表示当前节点是主节点。

---

## ✅ 二、优雅下线节点的步骤

### 🔁 方法一：临时下线一个 **非主节点的数据节点**

#### 步骤 1：启用分片迁移（确保该节点上的分片能迁移到其他节点）

```bash
PUT _cluster/settings
{
  "transient" : {
    "cluster.routing.allocation.enable" : "all"
  }
}
```

#### 步骤 2：将指定节点设为不可分配新分片（避免新分片再分配到该节点）

```bash
PUT _cluster/settings
{
  "transient": {
    "cluster.routing.allocation.exclude._ip": "10.0.0.11"
  }
}
```

> 替换 `10.0.0.11` 为你即将下线的节点 IP 地址。

Elasticsearch 会自动将该节点上的所有分片迁移到其他节点上。

你可以使用以下命令查看迁移进度：

```bash
GET _cat/recovery
```

等待所有分片迁移完成后，再继续下一步。

#### 步骤 3：确认节点已无分片

```bash
GET _cat/shards | grep '10.0.0.11'
```

如果没有输出，则说明该节点上已经没有分片了。

#### 步骤 4：关闭节点

你可以在目标节点上执行：

```bash
# Linux 下停止服务的方式取决于你的安装方式
sudo systemctl stop elasticsearch
```

或者直接终止进程。

---

### 🔁 方法二：永久移除一个节点（包括主节点）

如果该节点是主节点，并且你打算永久移除它，需要额外注意：

#### 1. 确保还有足够的主候选节点（master-eligible nodes）

至少保留 **3个主候选节点**（推荐奇数），以防止脑裂。

#### 2. 修改主节点配置文件（`elasticsearch.yml`）

在剩下的节点中更新：

```yaml
discovery.seed_hosts: ["host1", "host2"] # 去掉要下线节点的 host
cluster.initial_master_nodes: ["host1", "host2"] # 同样去掉该节点
```

> ⚠️ 注意：如果你使用的是 Elasticsearch 7.x 及以上版本，`initial_master_nodes` 只在首次启动时生效。如果是重启集群，修改此参数不会影响运行时行为。

#### 3. 关闭目标节点并完成分片迁移（同上）

---

## ✅ 三、后续处理

### 1. 清理配置

从所有节点的配置文件中删除下线节点的信息。

### 2. 检查集群状态

```bash
GET _cluster/state
```

确认节点列表中不再包含你要下线的节点。

---

## ✅ 四、常见问题解答

| 问题 | 解决方法 |
|------|----------|
| 节点上有主分片无法迁移？ | 确保有足够副本空间和其他可用节点；检查分片是否损坏。 |
| 集群状态变成 red？ | 说明某些主分片丢失，需先恢复数据或调整副本策略。 |
| 分片迁移卡住？ | 检查磁盘空间、网络延迟、负载情况；也可以尝试手动 reroute。 |

---

## ✅ 示例：完整流程（下线 node-2）

```bash
# 1. 允许分片分配
PUT _cluster/settings
{
  "transient": {
    "cluster.routing.allocation.enable": "all"
  }
}

# 2. 排除 node-2（IP: 10.0.0.11）
PUT _cluster/settings
{
  "transient": {
    "cluster.routing.allocation.exclude._ip": "10.0.0.11"
  }
}

# 3. 查看迁移进度
GET _cat/recovery

# 4. 确认 node-2 上无分片
GET _cat/shards | grep '10.0.0.11'

# 5. 安全关闭 node-2
sudo systemctl stop elasticsearch

# 6. 更新其他节点配置，去掉 node-2 的地址

# 7. 检查集群状态
GET _cluster/health?pretty
```

---

## ✅ 总结

| 步骤 | 目的 |
|------|------|
| 设置排除规则 | 让分片从目标节点迁移出去 |
| 等待迁移完成 | 防止数据丢失 |
| 关闭节点 | 安全下线 |
| 更新配置 | 移除对已下线节点的引用 |
| 检查集群状态 | 确保一切正常 |

---

如果你告诉我你的集群拓扑结构（比如节点数量、角色、ES 版本），我可以给你更定制化的建议 😊